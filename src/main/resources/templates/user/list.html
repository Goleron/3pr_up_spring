<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/navigation :: navbar}"></div>

<div class="container mt-4">
    <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

    <div class="mb-3">
        <a th:href="@{/users/new}" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <form th:action="@{/users}" method="get" class="row g-3 mb-3">
        <div class="col-md-6">
            <input type="text" name="search" th:value="${search}"
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email" class="form-control">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">üîç –ü–æ–∏—Å–∫</button>
        </div>
        <div class="col-md-2">
            <a th:href="@{/users}" class="btn btn-secondary w-100">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>

    <form id="deleteForm" th:action="@{/users/delete}" method="post">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th style="width: 50px;">
                    <input type="checkbox" id="selectAll" class="form-check-input">
                </th>
                <th>ID</th>
                <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                <th>Email</th>
                <th>–†–æ–ª–∏</th>
                <th>–ó–∞–∫–∞–∑–æ–≤</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="u : ${users}">
                <td>
                    <input type="checkbox" name="ids" th:value="${u.id}" class="form-check-input">
                </td>
                <td th:text="${u.id}"></td>
                <td>
                    <strong th:text="${u.username}"></strong>
                </td>
                <td th:text="${u.email}"></td>
                <td>
                    <span th:each="role, iter : ${u.roles}"
                          class="badge bg-primary me-1"
                          th:text="${role.name}"></span>
                    <span th:if="${u.roles.isEmpty()}" class="text-muted">‚Äî</span>
                </td>
                <td>
                    <span class="badge bg-info" th:text="${u.orders?.size() ?: 0}"></span>
                </td>
                <td>
                    <a th:href="@{/users/{id}/edit(id=${u.id})}" class="btn btn-sm btn-warning">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</a>
                    <a th:href="@{/profiles/user/{userId}(userId=${u.id})}" class="btn btn-sm btn-info">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="btn-group" role="group">
            <button type="submit" class="btn btn-warning" onclick="return confirm('–õ–æ–≥–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')">
                üóëÔ∏è –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            </button>
            <button type="button" class="btn btn-danger" onclick="hardDelete()">
                ‚ùå –§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            </button>
        </div>
    </form>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <nav th:if="${totalPages > 1}" class="mt-4">
        <ul class="pagination">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/users(page=${currentPage - 1}, size=10, search=${search})}">¬´</a>
            </li>
            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                class="page-item"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/users(page=${i}, size=10, search=${search})}" th:text="${i + 1}"></a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link" th:href="@{/users(page=${currentPage + 1}, size=10, search=${search})}">¬ª</a>
            </li>
        </ul>
    </nav>
</div>

<script>
    document.getElementById('selectAll').onclick = function() {
        document.querySelectorAll('input[name="ids"]').forEach(cb => cb.checked = this.checked);
    };

    function hardDelete() {
        if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—Ö –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –∑–∞–∫–∞–∑—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
            return;
        }
        const form = document.getElementById('deleteForm');
        form.action = '/users/hard-delete';
        form.submit();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>