<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .product-item:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/navigation :: navbar}"></div>

<div class="container mt-4">
    <h2>üõí –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>

    <form th:action="@{/orders}" method="post" class="needs-validation" novalidate>

        <!-- –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="mb-4">
            <label class="form-label fw-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
            <select name="userId" class="form-select" required>
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî</option>
                <option th:each="u : ${users}" th:value="${u.id}"
                        th:text="${u.username + ' (' + u.email + ')'}"></option>
            </select>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ -->
        <div class="mb-4">
            <label class="form-label fw-bold">–°—Ç–∞—Ç—É—Å</label>
            <select name="status" class="form-select">
                <option value="PENDING" selected>–û–∂–∏–¥–∞–µ—Ç</option>
                <option value="PROCESSING">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="COMPLETED">–í—ã–ø–æ–ª–Ω–µ–Ω</option>
                <option value="CANCELLED">–û—Ç–º–µ–Ω—ë–Ω</option>
            </select>
        </div>

        <!-- –í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="mb-4">
            <label class="form-label fw-bold">–¢–æ–≤–∞—Ä—ã *</label>
            <div class="alert alert-info">
                –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
            </div>

            <div id="products-container">
                <div th:each="p, iter : ${products}" class="product-item">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <input type="checkbox" class="form-check-input product-checkbox"
                                   th:id="'product-' + ${p.id}"
                                   th:value="${p.id}">
                        </div>
                        <div class="col-md-5">
                            <label th:for="'product-' + ${p.id}" class="form-check-label">
                                <strong th:text="${p.name}"></strong><br>
                                <small class="text-muted" th:text="${p.category?.name}"></small>
                            </label>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-success" th:text="${p.price + ' ‚ÇΩ'}"></span>
                            <span class="badge bg-secondary" th:text="'–û—Å—Ç–∞—Ç–æ–∫: ' + ${p.stock}"></span>
                        </div>
                        <div class="col-md-3">
                            <input type="number"
                                   th:name="'quantity_' + ${p.id}"
                                   class="form-control quantity-input"
                                   placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                                   min="1"
                                   th:max="${p.stock}"
                                   disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
        <div class="mb-4">
            <div class="card">
                <div class="card-body">
                    <h5>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: <span id="totalAmount">0.00</span> ‚ÇΩ</h5>
                </div>
            </div>
        </div>

        <div class="btn-group" role="group">
            <button type="submit" class="btn btn-primary btn-lg">üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
            <a th:href="@{/orders}" class="btn btn-secondary btn-lg">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—É–º–º—ã
    const products = {};
    /*[# th:each="p : ${products}"]*/
    products[/*[[${p.id}]]*/ 0] = {
        price: /*[[${p.price}]]*/ 0,
        stock: /*[[${p.stock}]]*/ 0
    };
    /*[/]*/

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ–≤–∞—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const productId = this.value;
            const quantityInput = document.querySelector(`input[name="quantity_${productId}"]`);

            if (this.checked) {
                quantityInput.disabled = false;
                quantityInput.value = 1;
                quantityInput.name = `productQuantities[${productId}]`;
            } else {
                quantityInput.disabled = true;
                quantityInput.value = '';
                quantityInput.name = `quantity_${productId}`;
            }

            calculateTotal();
        });
    });

    // –†–∞—Å—á—ë—Ç —Å—É–º–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', calculateTotal);
    });

    function calculateTotal() {
        let total = 0;

        document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
            const productId = checkbox.value;
            const quantity = parseInt(document.querySelector(`input[name="productQuantities[${productId}]"]`).value) || 0;
            const price = products[productId].price;

            total += price * quantity;
        });

        document.getElementById('totalAmount').textContent = total.toFixed(2);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>